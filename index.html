<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no"/>
<title>Voice Presence</title>

<style>
html, body {
  margin: 0;
  padding: 0;
  background: #0b0c10;
  overflow: hidden;
  font-family: system-ui, sans-serif;
}

video, canvas {
  position: absolute;
  inset: 0;
  width: 100%;
  height: 100%;
  object-fit: cover;
}

#hint {
  position: absolute;
  bottom: 24px;
  width: 100%;
  text-align: center;
  color: rgba(220,220,230,0.8);
  font-size: 14px;
  pointer-events: none;
  transition: opacity 0.4s ease;
}
</style>
</head>

<body>

<video id="video" autoplay muted playsinline></video>
<canvas id="canvas"></canvas>
<div id="hint"></div>

<script>
/* ===============================
   Camera
================================ */
const video = document.getElementById("video");
navigator.mediaDevices.getUserMedia({ video: { facingMode: "user" }, audio: true })
  .then(stream => video.srcObject = stream);

/* ===============================
   Audio Analysis (Voice Presence)
================================ */
const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
let analyser, data;

navigator.mediaDevices.getUserMedia({ audio: true }).then(stream => {
  const src = audioCtx.createMediaStreamSource(stream);
  analyser = audioCtx.createAnalyser();
  analyser.fftSize = 1024;
  data = new Uint8Array(analyser.frequencyBinCount);
  src.connect(analyser);
});

/* ===============================
   Presence Model (heuristic, local)
   – не громкость, а стабильность
================================ */
let presence = 0;
function updatePresence() {
  if (!analyser) return presence;

  analyser.getByteFrequencyData(data);

  let sum = 0, variance = 0;
  for (let i = 4; i < 64; i++) sum += data[i];
  const mean = sum / 60;

  for (let i = 4; i < 64; i++)
    variance += (data[i] - mean) ** 2;

  const stability = 1 / (1 + variance * 0.002);
  presence += (stability - presence) * 0.08;
  return presence;
}

/* ===============================
   Rendering
================================ */
const canvas = document.getElementById("canvas");
const ctx = canvas.getContext("2d");

function resize() {
  canvas.width = window.innerWidth;
  canvas.height = window.innerHeight;
}
window.addEventListener("resize", resize);
resize();

function render() {
  ctx.clearRect(0,0,canvas.width,canvas.height);

  const p = updatePresence();
  if (p > 0.02) {
    const r = 160 + p * 180;
    const g = ctx.createRadialGradient(
      canvas.width/2, canvas.height/2, r*0.3,
      canvas.width/2, canvas.height/2, r
    );
    g.addColorStop(0, `rgba(180,200,255,${0.35*p})`);
    g.addColorStop(1, "rgba(180,200,255,0)");

    ctx.fillStyle = g;
    ctx.beginPath();
    ctx.arc(canvas.width/2, canvas.height/2, r, 0, Math.PI*2);
    ctx.fill();
  }

  requestAnimationFrame(render);
}
render();

/* ===============================
   Minimal UX
================================ */
const hint = document.getElementById("hint");
let spoke = false;

setInterval(() => {
  if (presence > 0.05) spoke = true;
  hint.textContent = spoke ? "" : "speak";
  hint.style.opacity = spoke ? 0 : 0.6;
}, 300);
</script>

</body>
</html>
