<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Smile Lens</title>

<script src="https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/face_mesh.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>

<style>
html, body {
  margin: 0; padding: 0;
  background: #000; color: #fff;
  font-family: system-ui, sans-serif;
  overflow: hidden;
}
video, canvas {
  position: absolute;
  inset: 0;
  width: 100%;
  height: 100%;
  object-fit: cover;
}
#hud {
  position: fixed;
  bottom: 20px;
  width: 100%;
  text-align: center;
  pointer-events: none;
}
#label {
  font-size: 20px;
  opacity: 0.9;
}
#gear {
  position: fixed;
  top: 16px; right: 16px;
  font-size: 22px;
  pointer-events: auto;
  cursor: pointer;
}
#settings {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.85);
  display: none;
  padding: 20px;
}
select {
  font-size: 16px;
  margin: 8px 0;
  width: 100%;
}
</style>
</head>

<body>

<video id="video" autoplay muted playsinline></video>
<canvas id="canvas"></canvas>

<div id="gear">⚙️</div>

<div id="hud">
  <div id="label"></div>
</div>

<div id="settings">
  <h3>Settings</h3>
  <label>Language</label>
  <select id="lang">
    <option value="en">English</option>
    <option value="pt">Português (BR)</option>
    <option value="ru">Русский</option>
  </select>

  <label>Lens</label>
  <select id="mask">
    <option value="aura">Aura</option>
    <option value="glasses">Smart Glasses</option>
  </select>
</div>

<script>
/* ---------- i18n ---------- */
const TEXT = {
  en: { smile: "Natural smile" },
  pt: { smile: "Sorriso natural" },
  ru: { smile: "Естественная улыбка" }
};
let LANG = "en";
let MASK = "aura";

/* ---------- DOM ---------- */
const video = document.getElementById("video");
const canvas = document.getElementById("canvas");
const ctx = canvas.getContext("2d");
const label = document.getElementById("label");

/* ---------- State ---------- */
let neutralWidth = null;
let smileLevel = 0;
let smileHold = 0;

/* ---------- Utils ---------- */
const dist = (a,b)=>Math.hypot(a.x-b.x,a.y-b.y);

/* ---------- FaceMesh ---------- */
const faceMesh = new FaceMesh({
  locateFile: f => `https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/${f}`
});
faceMesh.setOptions({ maxNumFaces:1, refineLandmarks:true });

faceMesh.onResults(res => {
  canvas.width = video.videoWidth;
  canvas.height = video.videoHeight;
  ctx.clearRect(0,0,canvas.width,canvas.height);

  if (!res.multiFaceLandmarks) return;
  const f = res.multiFaceLandmarks[0];

  const mouthWidth = dist(f[61], f[291]);
  if (!neutralWidth) neutralWidth = mouthWidth;

  const ratio = mouthWidth / neutralWidth;
  const target = ratio > 1.12 ? 1 : 0;

  smileLevel += (target - smileLevel) * 0.15;
  smileHold = smileLevel > 0.8 ? smileHold + 1 : 0;

  drawEffect(f, smileLevel, smileHold);
  label.innerText = smileLevel > 0.6 ? TEXT[LANG].smile : "";
});

/* ---------- Effects ---------- */
function drawEffect(face, power, hold) {
  ctx.save();
  ctx.globalAlpha = power;

  if (MASK === "aura") {
    const c = face[1];
    const r = canvas.width * 0.25 + Math.sin(Date.now()/600)*20;
    const g = ctx.createRadialGradient(
      c.x*canvas.width, c.y*canvas.height, r*0.3,
      c.x*canvas.width, c.y*canvas.height, r
    );
    g.addColorStop(0, "rgba(255,255,200,0.8)");
    g.addColorStop(1, "rgba(0,255,180,0.0)");
    ctx.fillStyle = g;
    ctx.beginPath();
    ctx.arc(c.x*canvas.width, c.y*canvas.height, r, 0, Math.PI*2);
    ctx.fill();
  }

  if (MASK === "glasses") {
    ctx.strokeStyle = `rgba(0,200,255,${0.5+power})`;
    ctx.lineWidth = 4;
    const l = face[33], r = face[263];
    ctx.beginPath();
    ctx.rect(l.x*canvas.width-40, l.y*canvas.height-20, 80, 40);
    ctx.rect(r.x*canvas.width-40, r.y*canvas.height-20, 80, 40);
    ctx.stroke();
  }

  ctx.restore();
}

/* ---------- Camera ---------- */
new Camera(video, {
  facingMode:"user",
  onFrame: async()=>faceMesh.send({image:video})
}).start();

/* ---------- Settings ---------- */
const settings = document.getElementById("settings");
document.getElementById("gear").onclick = () =>
  settings.style.display = settings.style.display ? "" : "block";

document.getElementById("lang").onchange = e => LANG = e.target.value;
document.getElementById("mask").onchange = e => MASK = e.target.value;
</script>

</body>
</html>
